<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STILL | Sustainable Transformation Initiative for Land & Learning</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <style>
        /* ========== CSS Reset & Base ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans", sans-serif;
            background-color: #faf9f7;
            color: #2c3e50;
            line-height: 1.6;
        }

        /* ========== Navigation ========== */
        nav {
            position: sticky;
            top: 0;
            background-color: #fff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        nav ul {
            display: flex;
            justify-content: center;
            align-items: center;
            list-style: none;
            padding: 1rem 2rem;
            max-width: 1200px;
            margin: 0 auto;
            gap: 2rem;
        }

        nav a {
            text-decoration: none;
            color: #2c3e50;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        nav a:hover {
            background-color: #27ae60;
            color: #fff;
        }

        nav .logo {
            font-weight: 700;
            font-size: 1.25rem;
            letter-spacing: -1px;
            margin-right: auto;
        }

        /* ========== Sections ========== */
        section {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 4rem 2rem;
        }

        .section-content {
            max-width: 800px;
            width: 100%;
            text-align: center;
        }

        /* ========== Section Alternating Colors ========== */
        #home {
            background-color: #faf9f7;
        }

        #about {
            background-color: #fff;
        }

        #resume {
            background-color: #faf9f7;
        }

        #projects {
            background-color: #fff;
        }

        #contact {
            background-color: #2c3e50;
            color: #fff;
        }

        #contact h2, #contact p {
            color: #fff;
        }

        /* ========== Typography ========== */
        h1, h2, h3, h4 {
            font-family: 'Merriweather', Georgia, 'Times New Roman', serif;
        }

        h1 {
            font-size: 4rem;
            margin-bottom: 0.5rem;
            letter-spacing: -1px;
            color: #2c3e50;
            font-weight: 700;
        }

        h2 {
            font-size: 2.5rem;
            margin-bottom: 1.5rem;
            color: #2c3e50;
            font-weight: 700;
        }

        h3 {
            font-size: 1.5rem;
            font-weight: 400;
            color: #7f8c8d;
            margin-bottom: 2rem;
            line-height: 1.4;
        }

        p {
            font-size: 1.1rem;
            color: #34495e;
            margin-bottom: 1rem;
        }

        /* ========== Components ========== */
        .divider {
            width: 60px;
            height: 3px;
            background-color: #27ae60;
            margin: 2rem auto;
        }

        .tagline {
            font-style: italic;
            color: #95a5a6;
            font-size: 1.2rem;
            margin-top: 1.5rem;
        }

        /* ========== Cards Grid ========== */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-top: 2rem;
            max-width: 900px;
        }

        .section-intro {
            font-size: 1.1rem;
            color: #7f8c8d;
            margin-bottom: 1rem;
        }

        .card {
            background: #fff;
            border-radius: 8px;
            padding: 2rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-align: left;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .card h4 {
            font-size: 1.25rem;
            margin-bottom: 0.75rem;
            color: #2c3e50;
        }

        .card p {
            font-size: 1rem;
            color: #7f8c8d;
            flex-grow: 1;
            margin-bottom: 1.5rem;
        }

        .card-btn {
            display: inline-block;
            padding: 0.6rem 1.2rem;
            background-color: #27ae60;
            color: #fff;
            text-decoration: none;
            border-radius: 4px;
            font-size: 0.9rem;
            font-weight: 500;
            transition: background-color 0.3s ease;
            align-self: flex-start;
        }

        .card-btn:hover {
            background-color: #1e8449;
        }

        /* ========== Timeline (Resume) ========== */
        .timeline {
            text-align: left;
            max-width: 600px;
            margin: 2rem auto 0;
        }

        .timeline-item {
            padding-left: 2rem;
            border-left: 2px solid #27ae60;
            margin-bottom: 2rem;
            position: relative;
        }

        .timeline-item::before {
            content: '';
            width: 12px;
            height: 12px;
            background: #27ae60;
            border-radius: 50%;
            position: absolute;
            left: -7px;
            top: 0;
        }

        .timeline-item h4 {
            font-size: 1.1rem;
            color: #2c3e50;
            margin-bottom: 0.25rem;
        }

        .timeline-item .date {
            font-size: 0.9rem;
            color: #95a5a6;
            margin-bottom: 0.5rem;
        }

        .timeline-item p {
            font-size: 1rem;
            color: #7f8c8d;
        }

        .timeline-item .org {
            font-size: 0.95rem;
            color: #27ae60;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .resume-intro {
            font-size: 1.15rem;
            color: #34495e;
            margin-bottom: 2rem;
        }

        .timeline-heading {
            font-size: 1.3rem;
            color: #2c3e50;
            margin-top: 2.5rem;
            margin-bottom: 1.5rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* ========== Skills Grid ========== */
        .skills-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            justify-content: center;
            margin-top: 1rem;
        }

        .skill-category {
            background: #fff;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            flex: 1 1 200px;
            max-width: 250px;
            text-align: center;
        }

        .skill-category h4 {
            font-size: 1rem;
            color: #27ae60;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .skill-category p {
            font-size: 0.95rem;
            color: #7f8c8d;
            margin: 0;
        }

        /* ========== Contact Form ========== */
        .contact-info {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 2rem;
        }

        .contact-link {
            color: #fff;
            text-decoration: none;
            font-size: 1.1rem;
            padding: 0.75rem 1.5rem;
            border: 2px solid #fff;
            border-radius: 4px;
            transition: background-color 0.3s ease, color 0.3s ease;
            display: inline-block;
        }

        .contact-link:hover {
            background-color: #fff;
            color: #2c3e50;
        }

        /* ========== Dashboard Section ========== */
        #dashboard {
            background-color: #1a252f;
            color: #fff;
            min-height: auto;
            padding: 4rem 2rem;
        }

        #dashboard h2 {
            color: #fff;
        }

        #dashboard .divider {
            background-color: #27ae60;
        }

        .dashboard-container {
            max-width: 1200px;
            width: 100%;
            position: relative;
        }

        .map-wrapper {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        #map {
            height: 500px;
            width: 100%;
            border-radius: 8px;
            z-index: 1;
        }

        /* Stats Panel */
        .stats-panel {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(26, 37, 47, 0.95);
            border-radius: 8px;
            padding: 1.25rem;
            min-width: 220px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stats-panel h4 {
            color: #27ae60;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 1rem;
            font-family: 'Inter', sans-serif;
        }

        .stat-item {
            margin-bottom: 0.75rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #95a5a6;
            display: block;
            margin-bottom: 0.25rem;
        }

        .stat-value {
            font-size: 1.1rem;
            color: #fff;
            font-weight: 600;
        }

        .stat-value.loading {
            color: #7f8c8d;
            font-style: italic;
            font-weight: 400;
        }

        /* Layer Controls */
        .layer-controls {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .layer-btn {
            padding: 0.6rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s ease;
        }

        .layer-btn:hover {
            background: rgba(39, 174, 96, 0.3);
            border-color: #27ae60;
        }

        .layer-btn.active {
            background: #27ae60;
            border-color: #27ae60;
        }

        .territory-info {
            margin-top: 1rem;
            padding: 0.75rem;
            background: rgba(39, 174, 96, 0.15);
            border-radius: 4px;
            border-left: 3px solid #27ae60;
        }

        .territory-info .stat-label {
            color: #27ae60;
        }

        /* ========== Footer ========== */
        footer {
            background-color: #1a252f;
            color: #95a5a6;
            text-align: center;
            padding: 2rem;
            font-size: 0.9rem;
        }

        /* ========== Responsive ========== */
        @media (max-width: 768px) {
            nav ul {
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            nav .logo {
                margin-right: 0;
                width: 100%;
                text-align: center;
                margin-bottom: 0.5rem;
            }

            h1 {
                font-size: 2.5rem;
            }

            h2 {
                font-size: 1.75rem;
            }

            section {
                padding: 3rem 1.5rem;
            }

            .cards-grid {
                grid-template-columns: 1fr;
            }

            .skills-grid {
                flex-direction: column;
                align-items: center;
            }

            .skill-category {
                max-width: 100%;
            }

            #map {
                height: 350px;
            }

            .stats-panel {
                position: relative;
                top: auto;
                right: auto;
                margin-top: 1rem;
                width: 100%;
            }

            .layer-controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav>
        <ul>
            <li><a href="#home" class="logo">STILL</a></li>
            <li><a href="#home">Home</a></li>
            <li><a href="#about">About</a></li>
            <li><a href="#resume">Resume</a></li>
            <li><a href="#projects">Research Labs</a></li>
            <li><a href="#dashboard">Dashboard</a></li>
            <li><a href="#contact">Contact</a></li>
        </ul>
    </nav>

    <!-- Home Section -->
    <section id="home">
        <div class="section-content">
            <h1>STILL</h1>
            <h3>Sustainable Transformation Initiative<br>for Land & Learning</h3>
            
            <div class="divider"></div>
            
            <p>Advancing Indigenous sovereignty, heterodox economics, and adaptive resource management.</p>
            
            <div class="tagline">
                "Still" on the land. Transforming the future.
            </div>
        </div>
    </section>

    <!-- About Section -->
    <section id="about">
        <div class="section-content">
            <h2>About</h2>
            <div class="divider"></div>
            <p>STILL is dedicated to creating sustainable futures through the integration of Indigenous knowledge systems, innovative economic approaches, and responsible land stewardship.</p>
            <p>We believe in building bridges between traditional wisdom and contemporary challenges, fostering solutions that honor both the land and the communities that depend on it.</p>
        </div>
    </section>

    <!-- Resume Section -->
    <section id="resume">
        <div class="section-content">
            <h2>Resume</h2>
            <div class="divider"></div>
            <p class="resume-intro">Environmental professional with expertise in Indigenous land use planning, GIS, and project management.</p>
            
            <h3 class="timeline-heading">Experience</h3>
            <div class="timeline">
                <div class="timeline-item">
                    <h4>Protected Area Project Manager</h4>
                    <div class="org">Wuskwi Sipihk First Nation, Birch River, MB</div>
                    <div class="date">Aug 2025 ‚Äì Present</div>
                    <p>Leading development of a comprehensive vision and plan for a proposed Indigenous Protected Area in west-central Manitoba. Facilitating tri-Nation Working Group coordination, managing ECCC funding, and conducting community engagement to ensure land use plans reflect Nation values.</p>
                </div>
                <div class="timeline-item">
                    <h4>GIS Specialist</h4>
                    <div class="org">Chris Werner Consulting, Winnipeg, MB</div>
                    <div class="date">Oct 2023 ‚Äì Aug 2025</div>
                    <p>Designed and maintained geospatial systems supporting Indigenous communities in land claim negotiations. Built workflows for data analysis and cartography using ArcGIS and Python. Collaborated on monitoring during community culture camps in Northern Manitoba, Southern Nunavut, and NWT.</p>
                </div>
                <div class="timeline-item">
                    <h4>Environmental Program Manager</h4>
                    <div class="org">K√°t≈Ç'odeeche First Nation, Hay River, NT</div>
                    <div class="date">Jul 2021 ‚Äì Jan 2023</div>
                    <p>Led planning, implementation, and reporting of community-based environmental monitoring programs. Managed environmental data collection and analysis using MS Access and ArcGIS. Oversaw budget management and authored comprehensive technical reports.</p>
                </div>
                <div class="timeline-item">
                    <h4>Wildfire Firefighter / Crew Boss</h4>
                    <div class="org">GNWT & Evergreen Forestry Ltd., Hay River, NT</div>
                    <div class="date">2019 ‚Äì 2020</div>
                    <p>Suppressed forest fires in remote boreal environments; used GIS to map fire perimeters. Supervised crew during fire suppression operations in challenging remote conditions.</p>
                </div>
                <div class="timeline-item">
                    <h4>Research Assistant</h4>
                    <div class="org">Carleton University, Ottawa, ON</div>
                    <div class="date">Aug 2017 ‚Äì Apr 2018</div>
                    <p>Managed research project analyzing changes in growing season in the Canadian Arctic using remotely sensed data.</p>
                </div>
            </div>

            <h3 class="timeline-heading">Education</h3>
            <div class="timeline">
                <div class="timeline-item">
                    <h4>Master of Natural Resources Management</h4>
                    <div class="org">University of Manitoba, Winnipeg, MB</div>
                    <div class="date">In Progress</div>
                    <p>Coursework: Natural Resources Policy, Human Dimensions, Ecological Dimensions, Project Management.</p>
                </div>
                <div class="timeline-item">
                    <h4>Bachelor of Applied Technology ‚Äì GIS</h4>
                    <div class="org">SAIT, Calgary, AB</div>
                    <div class="date">2022</div>
                </div>
                <div class="timeline-item">
                    <h4>Diploma in Natural Resource Technology</h4>
                    <div class="org">Aurora College, Fort Smith, NT</div>
                    <div class="date">2018</div>
                    <p>Coursework: Aboriginal Land Claims and Self Government.</p>
                </div>
            </div>

            <h3 class="timeline-heading">Core Skills</h3>
            <div class="skills-grid">
                <div class="skill-category">
                    <h4>Land Management</h4>
                    <p>IPCAs, Land Use Planning, Environmental Monitoring</p>
                </div>
                <div class="skill-category">
                    <h4>Technical</h4>
                    <p>ArcGIS Pro, Python (ArcPy), Remote Sensing, Data Management</p>
                </div>
                <div class="skill-category">
                    <h4>Engagement</h4>
                    <p>Community Consultation, Stakeholder Facilitation, Government Relations</p>
                </div>
                <div class="skill-category">
                    <h4>Administration</h4>
                    <p>Proposal Writing, Budget Management ($300k+), Staff Supervision</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Projects Section -->
    <section id="projects">
        <div class="section-content">
            <h2>Research Labs</h2>
            <div class="divider"></div>
            <p class="section-intro">Exploring the intersection of Indigenous sovereignty, technology, and sustainable land management.</p>
            
            <div class="cards-grid">
                <div class="card">
                    <h4>IPCA Governance</h4>
                    <p>Visioning and policy development for the Wuskwi Sipihk, Sapotaweyak, and Minegoziibe First Nations.</p>
                    <a href="#" class="card-btn">Read More</a>
                </div>
                <div class="card">
                    <h4>Technical Sovereignty</h4>
                    <p>Developing local AI (Ollama) and mobile tools for field data collection.</p>
                    <a href="#" class="card-btn">Read More</a>
                </div>
                <div class="card">
                    <h4>Economic Research</h4>
                    <p>Heterodox economics and critiques of GDP in welfare policy.</p>
                    <a href="#" class="card-btn">Read More</a>
                </div>
                <div class="card">
                    <h4>Field Operations</h4>
                    <p>Drone surveys and CoMapeo implementation for land monitoring in Manitoba and Belize.</p>
                    <a href="#" class="card-btn">Read More</a>
                </div>
            </div>
        </div>
    </section>

    <!-- Dashboard Section -->
    <section id="dashboard">
        <div class="section-content dashboard-container">
            <h2>Field Dashboard</h2>
            <div class="divider"></div>
            <p style="color: #95a5a6; margin-bottom: 2rem;">Interactive Territory & Ecosystem Monitor</p>
            
            <div class="map-wrapper">
                <div id="map"></div>
                
                <!-- Stats Panel -->
                <div class="stats-panel">
                    <h4>Location Data</h4>
                    
                    <div class="territory-info">
                        <span class="stat-label">Indigenous Territory</span>
                        <span class="stat-value loading" id="territory-name">Locating...</span>
                    </div>
                    
                    <div class="stat-item">
                        <span class="stat-label">Human Development Index</span>
                        <span class="stat-value loading" id="hdi-value">--</span>
                    </div>
                    
                    <div class="stat-item">
                        <span class="stat-label">Biodiversity Intactness</span>
                        <span class="stat-value loading" id="biodiversity-value">--</span>
                    </div>
                </div>
            </div>
            
            <!-- Layer Controls -->
            <div class="layer-controls">
                <button class="layer-btn" id="btn-protected" title="Toggle Protected Areas layer">
                    üõ°Ô∏è Protected Areas
                </button>
                <button class="layer-btn" id="btn-ecosystems" title="Toggle Ecosystems layer">
                    üå≤ Tree Cover / Ecosystems
                </button>
                <button class="layer-btn" id="btn-satellite" title="Toggle Satellite imagery">
                    üõ∞Ô∏è Satellite View
                </button>
            </div>
        </div>
    </section>

    <!-- Contact Section -->
    <section id="contact">
        <div class="section-content">
            <h2>Contact</h2>
            <div class="divider"></div>
            <p>Interested in collaborating or learning more about STILL?</p>
            
            <div class="contact-info">
                <a href="mailto:hello@still.org" class="contact-link">hello@still.org</a>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <p>&copy; 2026 STILL - Sustainable Transformation Initiative for Land & Learning. All rights reserved.</p>
    </footer>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <script>
        // ========== Map Initialization ==========
        const map = L.map('map').setView([54.5, -97.5], 5); // Default: Manitoba

        // ========== Basemap Layers ==========
        const cartoPositron = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri'
        });

        // ========== Overlay Layers ==========
        // Protected Areas (placeholder using World Database on Protected Areas - simplified)
        const protectedAreas = L.tileLayer.wms('https://data-gis.unep-wcmc.org/server/services/ProtectedSites/WDPA_Latest/MapServer/WMSServer', {
            layers: '0',
            format: 'image/png',
            transparent: true,
            attribution: 'WDPA - Protected Planet',
            opacity: 0.6
        });

        // Tree Cover / Ecosystems (using OpenStreetMap landscape)
        const ecosystems = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data: &copy; OpenStreetMap contributors, SRTM | Map style: &copy; OpenTopoMap',
            maxZoom: 17,
            opacity: 0.7
        });

        // ========== Layer Control State ==========
        let protectedActive = false;
        let ecosystemsActive = false;
        let satelliteActive = false;

        // ========== Layer Toggle Buttons ==========
        document.getElementById('btn-protected').addEventListener('click', function() {
            protectedActive = !protectedActive;
            this.classList.toggle('active');
            if (protectedActive) {
                protectedAreas.addTo(map);
            } else {
                map.removeLayer(protectedAreas);
            }
        });

        document.getElementById('btn-ecosystems').addEventListener('click', function() {
            ecosystemsActive = !ecosystemsActive;
            this.classList.toggle('active');
            if (ecosystemsActive) {
                ecosystems.addTo(map);
            } else {
                map.removeLayer(ecosystems);
            }
        });

        document.getElementById('btn-satellite').addEventListener('click', function() {
            satelliteActive = !satelliteActive;
            this.classList.toggle('active');
            if (satelliteActive) {
                map.removeLayer(cartoPositron);
                satellite.addTo(map);
            } else {
                map.removeLayer(satellite);
                cartoPositron.addTo(map);
            }
        });

        // ========== User Location & Native Land API ==========
        let userMarker = null;

        // Custom marker icon
        const userIcon = L.divIcon({
            className: 'user-marker',
            html: '<div style="background: #27ae60; width: 16px; height: 16px; border-radius: 50%; border: 3px solid #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>',
            iconSize: [22, 22],
            iconAnchor: [11, 11]
        });

        function updateTerritoryDisplay(name) {
            const el = document.getElementById('territory-name');
            el.textContent = name;
            el.classList.remove('loading');
        }

        function queryNativeLand(lat, lng) {
            // Native-Land.ca API
            const url = `https://native-land.ca/api/index.php?maps=territories&position=${lat},${lng}`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data && data.length > 0) {
                        // Get all territory names
                        const territories = data.map(t => t.properties.Name).join(', ');
                        updateTerritoryDisplay(territories);
                        
                        // Update marker popup
                        if (userMarker) {
                            const popupContent = `
                                <div style="text-align: center; min-width: 200px;">
                                    <strong style="color: #27ae60;">Your Location</strong><br>
                                    <small style="color: #7f8c8d;">Traditional territory of:</small><br>
                                    <strong>${territories}</strong>
                                </div>
                            `;
                            userMarker.setPopupContent(popupContent).openPopup();
                        }
                    } else {
                        updateTerritoryDisplay('Data unavailable');
                    }
                })
                .catch(error => {
                    console.error('Native Land API error:', error);
                    updateTerritoryDisplay('Unable to fetch');
                });
        }

        function onLocationFound(e) {
            const { lat, lng } = e.latlng;
            
            // Fly to user location
            map.flyTo([lat, lng], 10, {
                duration: 2
            });
            
            // Add marker
            userMarker = L.marker([lat, lng], { icon: userIcon })
                .addTo(map)
                .bindPopup('<div style="text-align: center;"><strong>Your Location</strong><br><small>Fetching territory data...</small></div>')
                .openPopup();
            
            // Query Native Land API
            queryNativeLand(lat, lng);
        }

        function onLocationError(e) {
            console.warn('Geolocation error:', e.message);
            updateTerritoryDisplay('Location access denied');
            
            // Default to Manitoba view
            map.setView([54.5, -97.5], 6);
        }

        // Request user location
        if (navigator.geolocation) {
            map.locate({ setView: false, maxZoom: 12 });
            map.on('locationfound', onLocationFound);
            map.on('locationerror', onLocationError);
        } else {
            updateTerritoryDisplay('Geolocation not supported');
        }

        // ========== Click to Query Territory ==========
        map.on('click', function(e) {
            const { lat, lng } = e.latlng;
            
            // Remove existing marker
            if (userMarker) {
                map.removeLayer(userMarker);
            }
            
            // Add new marker
            userMarker = L.marker([lat, lng], { icon: userIcon })
                .addTo(map)
                .bindPopup('<div style="text-align: center;"><strong>Selected Location</strong><br><small>Fetching territory data...</small></div>')
                .openPopup();
            
            // Update stats panel
            document.getElementById('territory-name').textContent = 'Searching...';
            document.getElementById('territory-name').classList.add('loading');
            
            // Query for new location
            queryNativeLand(lat, lng);
        });
    </script>
</body>
</html>
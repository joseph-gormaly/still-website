<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | STILL</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/logo_v0.png">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
    <header>
        <div class="container">
            <nav role="navigation" aria-label="Main Navigation">
                <a href="index.html" class="logo">
                    <img src="assets/logo_v0.png" alt="STILL Logo">
                    STILL
                </a>
                <button class="mobile-menu-toggle" aria-label="Toggle navigation">
                    <span></span><span></span><span></span>
                </button>
                <ul class="nav-links">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="about.html">About</a></li>
                    <li><a href="resume.html">Resume</a></li>
                    <li><a href="projects.html">Research Labs</a></li>
                    <li><a href="timeline.html">Timeline</a></li>
                    <li><a href="dashboard.html" class="active">Dashboard</a></li>
                    <li><a href="bsv-calculator.html">BSV Calculator</a></li>
                    <li><a href="https://commerce.coinbase.com/checkout/bfaaf80e-dfa5-485a-b93f-b0f4b11cb4b4" class="btn-support" target="_blank" rel="noopener noreferrer">Support</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="dashboard-section">
        <div class="container">
            <h1>Field Dashboard</h1>
            <p style="text-align:center; color:#bdc3c7;">Interactive GIS-based Territory & Ecosystem Monitor</p>

            <div class="map-container">
                <div id="map"></div>
            </div>

            <div class="stats-panel">
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-label">Indigenous Territory</span>
                        <span class="stat-value" id="territory-name">Locating...</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Human Development Index</span>
                        <span class="stat-value">0.929</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Biodiversity Intactness</span>
                        <span class="stat-value">84%</span>
                    </div>
                </div>
            </div>

            <div class="layer-controls">
                <button class="layer-btn" id="btn-protected">üõ°Ô∏è Protected Areas</button>
                <button class="layer-btn" id="btn-ecosystems">üå≤ Tree Cover</button>
                <button class="layer-btn" id="btn-satellite">üõ∞Ô∏è Satellite View</button>
            </div>
        </div>
    </main>

    <footer role="contentinfo">
        <div class="container">
            <p>&copy; 2026 STILL | Sustainable Transformation Initiative for Land & Learning</p>
        </div>
    </footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/esri-leaflet@3.0.10/dist/esri-leaflet.js"></script>
    <script src="https://unpkg.com/esri-leaflet-vector@4.2.3/dist/esri-leaflet-vector.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const map = L.map('map').setView([54.5, -97.5], 5);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap &copy; CARTO'
            }).addTo(map);

            const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri'
            });

            // Layer 1: WDPA Protected Areas (via ArcGIS)
            const protectedAreas = L.esri.featureLayer({
                url: 'https://services5.arcgis.com/sjPPLDdu9vEzU79y/arcgis/rest/services/WDPA_Marine_and_Terrestrial_2023/FeatureServer/0',
                useCors: true,
                simplifyFactor: 0.5,
                precision: 4,
                style: function () {
                    return { color: '#27ae60', weight: 1.5, fillOpacity: 0.5 };
                }
            });

            // Layer 2: Tree Cover / Global Land Cover (Standard Tile Service)
            const treeCover = L.tileLayer('https://tiles.arcgis.com/tiles/P3ePLMYs2RVChqtp/arcgis/rest/services/Esri_2020_Land_Cover_V2/MapServer/tile/{z}/{y}/{x}', {
                opacity: 0.7,
                attribution: 'Esri 2020 Land Cover'
            });

            let satelliteActive = false;
            document.getElementById('btn-satellite').addEventListener('click', function() {
                satelliteActive = !satelliteActive;
                if (satelliteActive) { satellite.addTo(map); } else { map.removeLayer(satellite); }
                this.classList.toggle('active');
            });

            let protectedActive = false;
            document.getElementById('btn-protected').addEventListener('click', function() {
                protectedActive = !protectedActive;
                if (protectedActive) { protectedAreas.addTo(map); } else { map.removeLayer(protectedAreas); }
                this.classList.toggle('active');
            });

            let ecosystemsActive = false;
            document.getElementById('btn-ecosystems').addEventListener('click', function() {
                ecosystemsActive = !ecosystemsActive;
                if (ecosystemsActive) { treeCover.addTo(map); } else { map.removeLayer(treeCover); }
                this.classList.toggle('active');
            });

            // Territory Logic
            function queryNativeLand(lat, lng) {
                fetch(`https://native-land.ca/api/index.php?maps=territories&position=${lat},${lng}`)
                    .then(res => res.json())
                    .then(data => {
                        const name = data.length > 0 ? data.map(t => t.properties.Name).join(', ') : 'Data unavailable';
                        document.getElementById('territory-name').textContent = name;
                    });
            }

            map.on('click', e => queryNativeLand(e.latlng.lat, e.latlng.lng));
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(p => {
                    const latlng = [p.coords.latitude, p.coords.longitude];
                    map.flyTo(latlng, 8);
                    queryNativeLand(latlng[0], latlng[1]);
                });
            }

            document.querySelector('.mobile-menu-toggle').addEventListener('click', function() {
                document.querySelector('.nav-links').classList.toggle('active');
            });
        });
    </script>
</body>
</html>
